# JazzArchitect：基於遞歸機率文法的爵士和聲生成系統

**摘要**

本文介紹 JazzArchitect，一個基於 Rohrmeier (2020) 遞歸機率上下文無關文法框架的爵士和聲進行生成系統。系統以 C++ 實作，整合 JUCE 音訊框架，提供即時音訊合成與 MIDI 輸出功能。透過 15 參數風格向量控制，系統可生成 9 種不同爵士風格的和聲進行，包括乏波、酷派爵士、調式爵士等。系統實作三種主要替代規則（三全音替代、後門屬和弦、乘火車和聲）及 Smither (2019) 導引音聲部導進優化。本文詳述系統架構、演算法設計與實作細節。

**關鍵詞**：爵士和聲、機率上下文無關文法、和弦進行生成、聲部導進、音樂資訊檢索

---

## 一、緒論

### 1.1 研究動機

爵士和聲以其複雜的和弦進行與豐富的替代規則著稱。傳統的爵士即興演奏者透過長期學習掌握這些規則，但對於電腦音樂生成系統而言，如何模擬這種音樂知識仍是一大挑戰。

現有的音樂生成方法大致分為兩類：

1. **資料驅動方法**：使用深度學習（如長短期記憶網路、轉換器架構）從語料庫學習和聲模式
2. **規則式方法**：基於音樂理論規則進行生成

資料驅動方法雖能產生流暢的結果，但缺乏可解釋性與可控性。規則式方法則能精確控制生成過程，但傳統實作往往過於僵化。

### 1.2 研究目標

本研究旨在結合兩種方法的優點：

1. 採用 Rohrmeier (2020) 提出的遞歸文法框架，提供理論基礎
2. 透過機率權重控制規則選擇，增加生成多樣性
3. 實作風格參數系統，允許跨時代爵士風格生成
4. 提供完整的音訊合成與 MIDI 輸出功能

### 1.3 研究貢獻

本研究主要貢獻如下：

- 完整實作 Rohrmeier (2020) 機率上下文無關文法框架於 C++ 環境
- 設計 15 參數風格向量系統，支援 9 種爵士風格預設
- 整合三種主要替代規則與導引音聲部導進優化
- 開發具有圖形介面的獨立應用程式

---

## 二、相關研究

### 2.1 爵士和聲的形式文法

Steedman (1984) 首先提出以形式文法分析爵士和弦序列，將爵士和聲視為一種語言結構。該研究定義了基本的生成規則，但未處理機率權重問題。

Rohrmeier (2020) 擴展此框架，提出包含以下核心概念的遞歸文法：

- **延長（Prolongation）**：同功能和弦的重複或展開
- **準備（Preparation）**：屬功能和弦對目標和弦的準備
- **替代（Substitution）**：功能等價和弦的替換

### 2.2 機率上下文無關文法

Harasim 等人 (2018, 2020) 將機率上下文無關文法應用於爵士和聲樹狀資料庫，從 150 首爵士標準曲萃取規則權重。此方法結合了形式文法的結構性與統計方法的靈活性。

### 2.3 聲部導進理論

Smither (2019) 針對爵士和聲提出導引音聲部導進理論。核心概念為：

- **導引音**：每個和弦的第三音與第七音
- **平滑導進**：相鄰和弦的導引音應以最小音程移動
- **目標成本**：理想的聲部導進成本應小於等於 2 個半音

### 2.4 替代規則

爵士和聲中常見的替代規則包括：

| 替代類型 | 原和弦 | 替代和弦 | 理論基礎 |
|----------|--------|----------|----------|
| 三全音替代 | 屬七和弦 | 降二屬七 | 共享三全音音程 |
| 後門屬和弦 | 屬七和弦 | 降七屬七 | 小調借用 |
| 乘火車和聲 | 主和弦 | 大三度循環 | Coltrane 風格 |

---

## 三、系統架構

### 3.1 整體架構

JazzArchitect 採用分層架構設計：

```
使用者介面層
├── JUCE 圖形介面
└── 參數控制元件

生成層
├── 機率文法引擎
│   ├── 生成器
│   └── 規則庫
└── 風格引擎
    ├── 替代處理
    ├── 聲部導進優化
    └── 風格參數

核心層
├── 和弦符號
├── 音高類別
└── 音程計算

輸出層
├── 和弦合成器（8 複音）
└── MIDI 匯出器
```

### 3.2 模組說明

#### 核心模組
- **音高類別**：音高表示（0-11，C=0）
- **和弦品質**：和弦品質列舉（大七、小七、屬七、半減七、減七、增和弦）
- **和弦符號**：完整和弦符號，包含根音、品質、延伸音與變化音

#### 文法模組
- **非終端符號**：文法符號（起始、主、屬、下屬、準備、延長）
- **文法規則**：生成規則定義
- **機率文法**：機率上下文無關文法引擎
- **生成器**：自頂向下推導器

#### 風格模組
- **風格向量**：15 參數風格向量
- **風格預設**：9 種風格預設
- **風格引擎**：整合生成與後處理

#### 替代模組
- **三全音替代**：屬七轉降二屬七
- **後門替代**：屬七轉降七屬七
- **乘火車替代**：大三度循環替代
- **替代引擎**：統一替代處理器

#### 聲部導進模組
- **導引音分析**：第三音與第七音分析
- **聲部導進優化器**：最小化導進成本

#### 合成模組
- **和弦合成器**：8 複音和弦合成器
- **包絡產生器**：起音衰減延持釋放包絡
- **合成聲部**：單一合成聲部

#### MIDI 模組
- **MIDI 匯出器**：標準 MIDI 檔案匯出

---

## 四、文法引擎

### 4.1 非終端符號

系統定義以下非終端符號：

| 符號 | 名稱 | 功能 |
|------|------|------|
| S | 起始 | 起始符號（整首曲子）|
| T | 主功能 | 主和弦區域 |
| D | 屬功能 | 屬和弦區域 |
| SD | 下屬功能 | 下屬和弦區域 |
| PREP | 準備 | 準備區域 |
| PROL | 延長 | 延長區域 |

### 4.2 核心生成規則

#### 延長規則
延長規則透過重複或展開同功能和弦：

- 主功能延長：T 生成 T T
- 屬功能延長：D 生成 D D
- 右側延長：T 生成 T PROL
- 左側延長：T 生成 PROL T

#### 準備規則
準備規則插入屬功能和弦：

- 正格終止：T 生成 D T
- 變格終止：T 生成 SD T
- 二五進行：D 生成 PREP D
- 副屬和弦準備：PREP 生成 ii
- 重屬準備：PREP 生成 V/V

#### 替代規則
替代規則為單一生成規則：

- 三全音替代：屬七生成降二屬七
- 後門屬和弦：屬七生成降七屬七
- 乘火車和聲：主和弦生成大三度循環

### 4.3 規則機率

規則機率由風格向量控制。以二五進行為例：

- 選擇準備的機率 = 風格向量的二五偏好值
- 選擇延長的機率 = 1 - 二五偏好值

### 4.4 推導演算法

系統採用自頂向下遞歸推導：

1. 以起始符號 S 初始化推導樹
2. 當樹中仍有非終端符號時：
   - 選擇最左側非終端符號 N
   - 取得適用於 N 的規則
   - 根據風格參數加權規則
   - 依機率抽樣規則 r
   - 套用 r，以右側符號取代 N
3. 將終端符號映射為調性內的和弦符號
4. 回傳和弦進行

---

## 五、風格系統

### 5.1 風格向量參數

風格向量包含 15 個參數，控制生成行為：

| 參數 | 範圍 | 說明 |
|------|------|------|
| 三全音替代機率 | 0.0-1.0 | 三全音替代發生機率 |
| 二五偏好 | 0.0-1.0 | 二五進行使用偏好 |
| 調式互換 | 0.0-1.0 | 調式互換頻率 |
| 半音趨近 | 0.0-1.0 | 半音趨近頻率 |
| 屬和弦鏈深度 | 1-5 | 屬和弦連鎖最大深度 |
| 節奏密度 | 0.0-1.0 | 和弦變化密度 |
| 延伸音程度 | 0.0-1.0 | 延伸音使用程度 |
| 後門機率 | 0.0-1.0 | 後門屬和弦機率 |
| 乘火車機率 | 0.0-1.0 | 乘火車和聲機率 |
| 小調借用 | 0.0-1.0 | 小調借用頻率 |
| 減和弦使用 | 0.0-1.0 | 減和弦使用頻率 |
| 假終止 | 0.0-1.0 | 假終止機率 |
| 變格終止 | 0.0-1.0 | 變格終止機率 |
| 掛留音使用 | 0.0-1.0 | 掛留音使用頻率 |
| 持續低音機率 | 0.0-1.0 | 持續低音機率 |

### 5.2 風格預設

系統提供 9 種風格預設：

| 風格 | 三全音 | 二五 | 調式 | 延伸 | 特徵 |
|------|--------|------|------|------|------|
| 乏波 | 0.30 | 0.90 | 0.20 | 0.70 | 快速二五，豐富延伸音 |
| 酷派 | 0.20 | 0.70 | 0.30 | 0.50 | 較慢節奏，空間感 |
| 調式 | 0.10 | 0.30 | 0.70 | 0.30 | 少功能進行，調式色彩 |
| 硬乏波 | 0.35 | 0.85 | 0.25 | 0.60 | 藍調影響，強烈節奏 |
| 後乏波 | 0.40 | 0.60 | 0.60 | 0.80 | 現代和聲，複雜結構 |
| 搖擺 | 0.15 | 0.80 | 0.10 | 0.40 | 傳統進行，簡潔 |
| 融合 | 0.30 | 0.50 | 0.50 | 0.90 | 延伸音豐富，調式混合 |
| 當代 | 0.35 | 0.40 | 0.70 | 0.85 | 現代技法，自由結構 |
| 藍調 | 0.20 | 0.60 | 0.40 | 0.50 | 藍調進行，平行和弦 |

### 5.3 風格引擎

風格引擎整合生成流程：

1. 使用機率文法生成基礎進行
2. 套用替代引擎處理替代規則
3. 使用聲部導進優化器優化
4. 回傳最終進行

---

## 六、替代規則

### 6.1 三全音替代

三全音替代基於屬七和弦與降二屬七和弦共享相同的三全音音程：

- G7 的三全音：B-F（第三音與第七音）
- Db7 的三全音：F-Cb（第三音與第七音）

兩者共享 B/Cb 與 F，因此可互換。

實作時，系統以三全音替代機率將屬七和弦替換為降二屬七和弦。新根音計算方式為原根音加 6 個半音（三全音音程）。

### 6.2 後門屬和弦

後門屬和弦來自小調借用，以降七屬七取代屬七：

- 傳統進行：G7 解決至 Cmaj7
- 後門進行：Bb7 解決至 Cmaj7

實作以後門機率控制，新根音為原根音加 3 個半音（小三度上行）。

### 6.3 乘火車和聲

乘火車和聲源自乘火車的《乘火車步》，以大三度循環取代簡單進行：

- 傳統進行：主和弦
- 乘火車進行：大三屬七、降六大七、降二屬七、屬七、主和弦

實作時將單一主和弦擴展為 5 個和弦的序列。

---

## 七、聲部導進優化

### 7.1 導引音分析

根據 Smither (2019)，導引音為和弦的第三音與第七音：

| 和弦類型 | 第三音 | 第七音 |
|----------|--------|--------|
| Cmaj7 | E (4) | B (11) |
| Dm7 | F (5) | C (0) |
| G7 | B (11) | F (5) |

### 7.2 聲部導進成本

兩和弦間的聲部導進成本定義為導引音的最小移動量：

成本 = |第三音1 - 第三音2| + |第七音1 - 第七音2|

其中音程以最小值計算（考慮八度等價）。

### 7.3 優化演算法

聲部導進優化器檢查每對相鄰和弦，若成本過高則嘗試替代：

1. 對於每對相鄰和弦
2. 計算聲部導進成本
3. 若成本大於 2：
   - 嘗試對第一個和弦套用三全音替代
   - 計算新成本
   - 若新成本較低則套用替代
4. 回傳優化後的進行

---

## 八、音訊合成

### 8.1 合成器架構

和弦合成器為 8 複音和弦合成器，支援三種音色：

| 音色 | 合成方式 | 特徵 |
|------|----------|------|
| 電鋼琴 | 頻率調變合成 | Rhodes 風格，衰減調變 |
| 風琴 | 加法合成 | Hammond 風格，泛音疊加 |
| 鋪底音色 | 減法合成 | 鋸齒波加低通濾波 |

### 8.2 包絡設定

每個合成聲部包含獨立的起音衰減延持釋放包絡：

| 音色 | 起音 | 衰減 | 延持 | 釋放 |
|------|------|------|------|------|
| 電鋼琴 | 5 毫秒 | 300 毫秒 | 0.3 | 400 毫秒 |
| 風琴 | 10 毫秒 | 50 毫秒 | 0.9 | 100 毫秒 |
| 鋪底音色 | 200 毫秒 | 500 毫秒 | 0.7 | 800 毫秒 |

### 8.3 和弦配置

和弦符號的 MIDI 音符取得方法：

1. 計算根音 MIDI 值 = 基礎八度 * 12 + 根音
2. 加入根音
3. 對於和弦品質中的每個音程，加入對應音符
4. 對於每個延伸音，加入對應音符
5. 回傳音符列表

---

## 九、實作細節

### 9.1 開發環境

- **程式語言**：C++17
- **音訊框架**：JUCE 7.x
- **建構系統**：CMake 3.22 以上
- **目標平台**：macOS（ARM64/x86_64）

### 9.2 檔案結構

```
cpp/
├── Source/
│   ├── Core/           # 核心類別
│   ├── Grammar/        # 文法引擎
│   ├── Style/          # 風格系統
│   ├── Substitution/   # 替代規則
│   ├── VoiceLeading/   # 聲部導進
│   ├── Synthesis/      # 音訊合成
│   ├── MIDI/           # MIDI 輸出
│   ├── Main.cpp
│   ├── MainComponent.h
│   └── MainComponent.cpp
├── JUCE/               # JUCE 子模組
├── CMakeLists.txt
└── build/
```

### 9.3 編譯方式

```bash
cd cpp
mkdir build && cd build
cmake ..
cmake --build . --config Release
```

### 9.4 應用程式規格

- **檔案大小**：約 11 MB
- **最低需求**：macOS 10.13 以上
- **音訊引擎**：CoreAudio，48 kHz
- **CPU 使用率**：極低（小於 1%）

---

## 十、使用者介面

### 10.1 介面配置

```
┌─────────────────────────────────────────────────────────────┐
│ Jazz Architect                                              │
├─────────────────────────────────────────────────────────────┤
│ 風格: [乏波    v]  調性: [C      v]  音色: [電鋼琴  v]      │
│ 速度: [===120===]    長度: [===8===]                        │
│                                                             │
│ [生成]  [播放]  [停止]  [匯出 MIDI]                         │
├─────────────────────────────────────────────────────────────┤
│                      和弦進行                               │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐     │
│  │Dm7   │ │G7    │ │Cmaj7 │ │A7    │ │Dm7   │ │G7    │     │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘     │
├─────────────────────────────────────────────────────────────┤
│ 三全音 [═══○═══]  二五 [═══════○]  調式 [═○═══════]        │
│ 延伸   [═════○═]                                            │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 操作流程

1. 選擇風格預設（或調整參數滑桿）
2. 選擇調性與長度
3. 點擊「生成」產生新進行
4. 點擊「播放」播放（可選擇音色）
5. 點擊「匯出 MIDI」匯出檔案

---

## 十一、結論與未來工作

### 11.1 成果總結

本研究成功實作 JazzArchitect 系統，達成以下目標：

1. **理論整合**：完整實作 Rohrmeier (2020) 機率上下文無關文法框架
2. **風格控制**：15 參數風格向量與 9 種預設
3. **替代規則**：三全音、後門、乘火車替代
4. **聲部優化**：Smither (2019) 導引音導進
5. **實用工具**：圖形介面、音訊合成、MIDI 輸出

### 11.2 未來工作

1. **語料庫訓練**：從爵士和聲樹狀資料庫萃取規則機率
2. **評估整合**：加入 MusDr 評估指標
3. **聽覺實驗**：進行 A/B 比較測試
4. **樂譜顯示**：加入五線譜視覺化
5. **即時 MIDI**：連接外部合成器
6. **跨平台**：Windows/Linux 版本

---

## 參考文獻

1. Rohrmeier, M. (2020). Towards a Syntax of Jazz Harmony. *Music Theory and Analysis*, 7(1), 1-62.

2. Steedman, M. J. (1984). A generative grammar for jazz chord sequences. *Music Perception*, 2(1), 52-77.

3. Smither, S. (2019). Guide-tone voice leading in jazz. *Music Theory Online*, 25(2).

4. Harasim, D., Finkensiep, C., Ericson, P., O'Donnell, T. J., & Rohrmeier, M. (2020). The jazz harmony treebank. *Proceedings of ISMIR 2020*.

5. Tymoczko, D. (2006). The geometry of musical chords. *Science*, 313(5783), 72-74.

6. Wu, S. L., & Yang, Y. H. (2020). The jazz transformer on the front line: Exploring the shortcomings of AI-composed music through quantitative measures. *Proceedings of ISMIR 2020*.

7. Granroth-Wilding, M., & Steedman, M. (2014). A robust parser-interpreter for jazz chord sequences. *Journal of New Music Research*, 43(4), 355-374.

---

## 附錄甲：和弦品質音程表

| 和弦品質 | 音程（半音）|
|----------|-------------|
| 大七和弦 | 0, 4, 7, 11 |
| 小七和弦 | 0, 3, 7, 10 |
| 屬七和弦 | 0, 4, 7, 10 |
| 半減七和弦 | 0, 3, 6, 10 |
| 減七和弦 | 0, 3, 6, 9 |
| 增和弦 | 0, 4, 8 |
| 大六和弦 | 0, 4, 7, 9 |
| 小六和弦 | 0, 3, 7, 9 |

## 附錄乙：非終端符號終端映射

| 非終端 | 功能 | 常見終端 |
|--------|------|----------|
| T | 主功能 | 主大七、六級七、三級七 |
| D | 屬功能 | 屬七、七級半減七 |
| SD | 下屬功能 | 四級、二級七 |
| PREP | 準備 | 二級七、四級 |

---

*JazzArchitect 版本 1.0 - 2026 年 1 月 2 日*
